<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8">
    <title>KeeperPlugin</title>
    <link href="../../../images/logo-icon.svg" rel="icon" type="image/svg">
    <script>var pathToRoot = "../../../";</script>
    <script>const storage = localStorage.getItem("dokka-dark-mode")
    if (storage == null) {
        const osDarkSchemePreferred = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches
        if (osDarkSchemePreferred === true) {
            document.getElementsByTagName("html")[0].classList.add("theme-dark")
        }
    } else {
        const savedDarkMode = JSON.parse(storage)
        if(savedDarkMode === true) {
            document.getElementsByTagName("html")[0].classList.add("theme-dark")
        }
    }
    </script>
<script type="text/javascript" src="../../../scripts/sourceset_dependencies.js" async="async"></script>
<link href="../../../styles/style.css" rel="Stylesheet">
<link href="../../../styles/jetbrains-mono.css" rel="Stylesheet">
<link href="../../../styles/main.css" rel="Stylesheet">
<link href="../../../styles/prism.css" rel="Stylesheet">
<link href="../../../styles/logo-styles.css" rel="Stylesheet">
<script type="text/javascript" src="../../../scripts/clipboard.js" async="async"></script>
<script type="text/javascript" src="../../../scripts/navigation-loader.js" async="async"></script>
<script type="text/javascript" src="../../../scripts/platform-content-handler.js" async="async"></script>
<script type="text/javascript" src="../../../scripts/main.js" defer="defer"></script>
<script type="text/javascript" src="../../../scripts/prism.js" async="async"></script>
<script type="text/javascript" src="../../../scripts/symbol-parameters-wrapper_deferred.js" defer="defer"></script>
</head>
<body>
<div class="navigation-wrapper" id="navigation-wrapper">
    <div id="leftToggler"><span class="icon-toggler"></span></div>
    <div class="library-name">
            <a href="../../../index.html">
                    <span>keeper-gradle-plugin</span>
            </a>
    </div>
    <div>
    </div>
    <div class="pull-right d-flex">
        <div class="filter-section" id="filter-section">
                <button class="platform-tag platform-selector jvm-like" data-active="" data-filter=":dokkaHtml/main">jvm</button>
        </div>
        <button id="theme-toggle-button"><span id="theme-toggle"></span></button>
        <div id="searchBar"></div>
    </div>
</div>
<div id="container">
    <div id="leftColumn">
        <div id="sideMenu"></div>
    </div>
    <div id="main">
<div class="main-content" data-page-type="classlike" id="content" pageIds="keeper-gradle-plugin::com.slack.keeper/KeeperPlugin///PointingToDeclaration//769193423">
  <div class="breadcrumbs"><a href="../../../index.html">keeper-gradle-plugin</a><span class="delimiter">/</span><a href="../index.html">com.slack.keeper</a><span class="delimiter">/</span><span class="current">KeeperPlugin</span></div>
  <div class="cover ">
    <h1 class="cover"><span>Keeper</span><wbr></wbr><span><span>Plugin</span></span></h1>
    <div class="platform-hinted " data-platform-hinted="data-platform-hinted"><div class="content sourceset-dependent-content" data-active="" data-togglable=":dokkaHtml/main"><div class="symbol monospace"><span class="token keyword">class </span><a href="index.html">KeeperPlugin</a> : <a href="https://docs.gradle.org/8.2.1/javadoc/allpackages-index.html/org/gradle/api/Plugin.html">Plugin</a><span class="token operator">&lt;</span><span class="token keyword"></span><a href="https://docs.gradle.org/8.2.1/javadoc/allpackages-index.html/org/gradle/api/Project.html">Project</a><span class="token operator">&gt; </span></div><p class="paragraph">A simple Gradle plugin that hooks into Proguard/R8 to add extra keep rules based on what androidTest classes use from the target app's sources. This is necessary because AGP does not factor in androidTest usages of target app sources when running the minification step, which can result in runtime errors if APIs used by tests are removed.</p><p class="paragraph">This is a workaround until AGP supports this: https://issuetracker.google.com/issues/126429384.</p><p class="paragraph">This is optionally configurable via the <a href="../-keeper-extension/index.html"><code class="lang-kotlin">keeper</code></a> extension. For example:</p><div class="sample-container"><pre><code class="block lang-kotlin" theme="idea">keeper {<br>  automaticR8RepoManagement = false<br>  r8JvmArgs = [&quot;-Xdebug&quot;, &quot;-Xrunjdwp:transport=dt_socket,address=5005,server=y,suspend=y&quot;]<br>}</code></pre><span class="top-right-position"><span class="copy-icon"></span><div class="copy-popup-wrapper popup-to-left"><span class="copy-popup-icon"></span><span>Content copied to clipboard</span></div></span></div><p class="paragraph">The general logic flow:</p><ul><li><p class="paragraph">Create a custom <code class="lang-kotlin">r8</code> configuration for the R8 dependency.</p></li><li><p class="paragraph">Register two jar tasks. One for all the classes in its target <code class="lang-kotlin">testedVariant</code> and one for all the classes in the androidTest variant itself. This will use their variant-provided <a href="https://docs.gradle.org/8.2.1/javadoc/allpackages-index.html/org/gradle/api/tasks/compile/JavaCompile.html">JavaCompile</a> tasks and <span data-unresolved-link="org.jetbrains.kotlin.gradle.tasks/KotlinCompile///PointingToDeclaration/">KotlinCompile</span> tasks if available.</p></li><li><p class="paragraph">Register a <a href="../-infer-android-test-keep-rules/index.html"><code class="lang-kotlin">infer${androidTestVariant}UsageForKeeper</code></a> task that plugs the two aforementioned jars into R8's <code class="lang-kotlin">TraceReferences</code> CLI and outputs the inferred proguard rules into a new intermediate .pro file.</p></li><li><p class="paragraph">Finally - the generated file is wired in to Proguard/R8 via private task APIs and setting their <code class="lang-kotlin">configurationFiles</code> to include our generated one.</p></li></ul><p class="paragraph">Appropriate task dependencies (via inputs/outputs, not <code class="lang-kotlin">dependsOn</code>) are set up, so this is automatically run as part of the target app variant's full minified APK.</p><p class="paragraph">The tasks themselves take roughly ~20 seconds total extra work in the Slack android app, with the infer and app jar tasks each taking around 8-10 seconds and the androidTest jar taking around 2 seconds.</p></div></div>
  </div>
  <div class="tabbedcontent">
    <div class="tabs-section" tabs-section="tabs-section"><button class="section-tab" data-active="" data-togglable="CONSTRUCTOR,TYPE,PROPERTY,FUNCTION">Members</button></div>
    <div class="tabs-section-body">
      <div data-togglable="CONSTRUCTOR">
        <h2 class="">Constructors</h2>
        <div class="table"><a data-name="1871676864%2FConstructors%2F769193423" anchor-label="KeeperPlugin" id="1871676864%2FConstructors%2F769193423" data-filterable-set=":dokkaHtml/main"></a>
          <div class="table-row" data-togglable="CONSTRUCTOR" data-filterable-current=":dokkaHtml/main" data-filterable-set=":dokkaHtml/main">
            <div class="main-subrow keyValue ">
              <div class=""><span class="inline-flex">
                  <div><a href="-keeper-plugin.html"><span>Keeper</span><wbr></wbr><span><span>Plugin</span></span></a></div>
<span class="anchor-wrapper"><span class="anchor-icon" pointing-to="1871676864%2FConstructors%2F769193423"></span>
                    <div class="copy-popup-wrapper "><span class="copy-popup-icon"></span><span>Link copied to clipboard</span></div>
                  </span></span></div>
              <div>
                <div class="title">
                  <div class="platform-hinted " data-platform-hinted="data-platform-hinted"><div class="content sourceset-dependent-content" data-active="" data-togglable=":dokkaHtml/main"><div class="symbol monospace"><span class="token keyword">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span></div></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div data-togglable="FUNCTION">
        <h2 class="">Functions</h2>
        <div class="table"><a data-name="-1639140097%2FFunctions%2F769193423" anchor-label="apply" id="-1639140097%2FFunctions%2F769193423" data-filterable-set=":dokkaHtml/main"></a>
          <div class="table-row" data-filterable-current=":dokkaHtml/main" data-filterable-set=":dokkaHtml/main">
            <div class="main-subrow keyValue ">
              <div class=""><span class="inline-flex">
                  <div><a href="apply.html"><span><span>apply</span></span></a></div>
<span class="anchor-wrapper"><span class="anchor-icon" pointing-to="-1639140097%2FFunctions%2F769193423"></span>
                    <div class="copy-popup-wrapper "><span class="copy-popup-icon"></span><span>Link copied to clipboard</span></div>
                  </span></span></div>
              <div>
                <div class="title">
                  <div class="platform-hinted " data-platform-hinted="data-platform-hinted"><div class="content sourceset-dependent-content" data-active="" data-togglable=":dokkaHtml/main"><div class="symbol monospace"><span class="token keyword">open </span><span class="token keyword">override </span><span class="token keyword">fun </span><a href="apply.html"><span class="token function">apply</span></a><span class="token punctuation">(</span><span class="parameters "><span class="parameter ">project<span class="token operator">: </span><a href="https://docs.gradle.org/8.2.1/javadoc/allpackages-index.html/org/gradle/api/Project.html">Project</a></span></span><span class="token punctuation">)</span></div></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
      <div class="footer">
        <span class="go-to-top-icon"><a href="#content" id="go-to-top-link"></a></span><span>Â© 2023 Copyright</span><span
                class="pull-right"><span>Generated by </span><a
                href="https://github.com/Kotlin/dokka"><span>dokka</span><span class="padded-icon"></span></a></span>
      </div>
    </div>
</div>
</body>
</html>
